name: Build & Deploy Database Stack

on:
  push:
    branches:
      - docker-swarm

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push cache-loading-backend image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/cache-loading-backend:latest ./cache-loading-backend
          docker push ${{ secrets.DOCKER_USERNAME }}/cache-loading-backend:latest

      - name: Build and push core-operational-backend image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/core-operational-backend:latest ./core-operational-backend
          docker push ${{ secrets.DOCKER_USERNAME }}/core-operational-backend:latest

      - name: Build and push entrance-cockpit-backend image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/entrance-cockpit-backend:latest ./entrance-cockpit-backend
          docker push ${{ secrets.DOCKER_USERNAME }}/entrance-cockpit-backend:latest

      - name: Build and push static-server-backend image
        run: |
          docker build --build-arg VITE_WS_URL="wss://172.31.249.144/entrance/ws" -t ${{ secrets.DOCKER_USERNAME }}/static-server-backend:latest ./static-server-backend
          docker push ${{ secrets.DOCKER_USERNAME }}/static-server-backend:latest

      - name: Build and push telemetry-to-messaging-backend image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/telemetry-to-messaging-backend:latest ./telemetry-to-messaging-backend
          docker push ${{ secrets.DOCKER_USERNAME }}/telemetry-to-messaging-backend:latest


      - name: Deploy stack to Swarm
        run: |
          docker stack deploy -c docker-stack.yml jwick_stack